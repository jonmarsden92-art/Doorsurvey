<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Door Survey App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; padding-bottom: 20px; -webkit-font-smoothing: antialiased; }
        h1 { background: #007bff; color: white; margin: 0; padding: 16px; font-size: 22px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 16px 0; font-size: 18px; color: #333; }
        .section { background: #fff; padding: 16px; margin: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 600; font-size: 14px; color: #555; }
        input, textarea { width: 100%; padding: 12px; margin: 0; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: #fafafa; transition: all 0.2s; }
        input:focus, textarea:focus { outline: none; border-color: #007bff; background: white; }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        button { width: 100%; padding: 14px; margin-top: 12px; font-size: 16px; font-weight: 600; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; }
        button:active { transform: scale(0.98); box-shadow: 0 1px 4px rgba(0,123,255,0.3); }
        button.secondary { background: #6c757d; box-shadow: 0 2px 8px rgba(108,117,125,0.3); }
        button.copy { background: #28a745; box-shadow: 0 2px 8px rgba(40,167,69,0.3); }
        button.danger { background: #dc3545; box-shadow: 0 2px 8px rgba(220,53,69,0.3); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { border: 1px solid #ddd; padding: 8px 6px; font-size: 13px; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; font-weight: 600; position: sticky; top: 0; }
        tr:nth-child(even) { background: #f9f9f9; }
        .door-count { background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block; margin-bottom: 12px; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .install-prompt { background: #fff3cd; border: 2px solid #ffc107; padding: 12px; margin: 12px; border-radius: 8px; display: none; }
        #pdfStatus { font-size: 13px; color: #444; margin-top: 8px; }
    </style>
</head>
<body>

<h1>üö™ Door Survey</h1>

<div id="installPrompt" class="install-prompt">
    <strong>üì± Install this app!</strong>
    <p style="margin: 8px 0; font-size: 14px;">Add to your home screen for easy access and offline use.</p>
    <button onclick="installApp()">Install App</button>
    <button onclick="document.getElementById('installPrompt').style.display='none'" style="background: #6c757d; margin-top: 4px;">Maybe Later</button>
</div>

<div class="section">
    <h2>Project Information</h2>
    <label>Project Ref</label><input id="projectRef">
    <label>Project Name</label><input id="projectName">
    <label>Survey Date</label><input id="surveyDate" type="date">
    <label>Surveyor Name</label><input id="surveyorName">
</div>

<div class="section">
    <h2>Add Door</h2>
    <button class="copy" onclick="copyPrevious()">üîÅ Copy Previous Door Details</button>

    <label>Door Number</label><input id="doorNumber" type="text" placeholder="e.g., D01">
    <label>Door Name</label><input id="doorName" type="text" placeholder="e.g., Main Entrance">
    <label>Width (mm)</label><input id="width" type="number">
    <label>Height (mm)</label><input id="height" type="number">
    <label>Frame Depth</label><input id="frameDepth" type="text">
    <label>Dimension Detail</label><textarea id="dimDetail"></textarea>
    <label>Existing Door Thickness</label><input id="doorThickness" type="text">
    <label>Existing Frame Profile 1</label><input id="frameProfile1" type="text">
    <label>Existing Frame Profile 2</label><input id="frameProfile2" type="text">
    <label>Door Leaf Finish</label><input id="doorLeafFinish" type="text">
    <label>Door Frame Finish</label><input id="doorFrameFinish" type="text">
    <label>Existing Architrave Profile</label><input id="architraveProfile" type="text">
    <label>Existing Cylinder Profile</label><input id="cylinderProfile" type="text">
    <label>Existing Suite Ref</label><input id="suiteRef" type="text">
    <label>Existing Override Type</label><input id="overrideType" type="text">
    <label>Handing</label><input id="handing" type="text" placeholder="e.g., LH or RH">

    <button onclick="addDoor()">‚ûï Add Door to Schedule</button>
</div>

<div class="section">
    <h2>Door Schedule</h2>
    <div class="door-count" id="doorCount">0 Doors Added</div>
    <div class="table-container">
        <table id="doorTable">
            <thead>
                <tr>
                    <th>Door No.</th><th>Door Name</th><th>Width</th><th>Height</th><th>Frame Depth</th>
                    <th>Dim Detail</th><th>Thickness</th><th>Frame 1</th><th>Frame 2</th>
                    <th>Leaf Finish</th><th>Frame Finish</th><th>Architrave</th><th>Cylinder</th>
                    <th>Suite Ref</th><th>Override</th><th>Handing</th><th>Action</th>
                </tr>
            </thead>
            <tbody id="doorTableBody"></tbody>
        </table>
    </div>

    <div class="button-group">
        <button class="secondary" onclick="exportCSV()">üì§ Export CSV</button>
        <div>
            <button class="secondary" onclick="exportPDF()">üìÑ Export PDF</button>
            <div id="pdfStatus" aria-live="polite"></div>
        </div>
    </div>
    <button class="danger" onclick="clearAllDoors()">üóëÔ∏è Clear All Doors</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
    const pdfStatus = document.getElementById('pdfStatus');
    function setPdfStatus(msg, isError) {
        if (!pdfStatus) return;
        pdfStatus.innerText = msg;
        pdfStatus.style.color = isError ? '#b2302d' : '#2b7a0b';
    }

    if (typeof window.html2pdf !== 'undefined') {
        setPdfStatus('PDF export library loaded ‚úì');
    } else {
        setPdfStatus('PDF export library not available', true);
        let tries = 0;
        const checkInterval = setInterval(() => {
            tries++;
            if (typeof window.html2pdf !== 'undefined') {
                setPdfStatus('PDF export library loaded ‚úì');
                clearInterval(checkInterval);
            } else if (tries > 20) {
                setPdfStatus('PDF library failed to load. Use CSV export or try desktop Safari/Chrome.', true);
                clearInterval(checkInterval);
            }
        }, 500);
    }

    document.getElementById("surveyDate").value = new Date().toISOString().split("T")[0];
    let doors = [];
    let lastDoor = null;
    let deferredPrompt;

    function loadData() {
        try {
            const saved = localStorage.getItem('doorSurveyData');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('projectRef').value = data.projectRef || '';
                document.getElementById('projectName').value = data.projectName || '';
                document.getElementById('surveyDate').value = data.surveyDate || '';
                document.getElementById('surveyorName').value = data.surveyorName || '';
                doors = data.doors || [];
                refreshTable();
            }
        } catch (e) { console.error('Error loading data', e); }
    }

    function saveData() {
        const data = {
            projectRef: document.getElementById('projectRef').value,
            projectName: document.getElementById('projectName').value,
            surveyDate: document.getElementById('surveyDate').value,
            surveyorName: document.getElementById('surveyorName').value,
            doors: doors
        };
        localStorage.setItem('doorSurveyData', JSON.stringify(data));
    }

    ['projectRef', 'projectName', 'surveyDate', 'surveyorName'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', saveData);
    });

    function addDoor() {
        const dNo = document.getElementById('doorNumber').value.trim();
        if (!dNo) { alert('Please enter a Door Number'); return; }
        const doorData = {
            doorNumber: dNo,
            doorName: document.getElementById('doorName').value,
            width: document.getElementById('width').value,
            height: document.getElementById('height').value,
            frameDepth: document.getElementById('frameDepth').value,
            dimDetail: document.getElementById('dimDetail').value,
            doorThickness: document.getElementById('doorThickness').value,
            frameProfile1: document.getElementById('frameProfile1').value,
            frameProfile2: document.getElementById('frameProfile2').value,
            doorLeafFinish: document.getElementById('doorLeafFinish').value,
            doorFrameFinish: document.getElementById('doorFrameFinish').value,
            architraveProfile: document.getElementById('architraveProfile').value,
            cylinderProfile: document.getElementById('cylinderProfile').value,
            suiteRef: document.getElementById('suiteRef').value,
            overrideType: document.getElementById('overrideType').value,
            handing: document.getElementById('handing').value
        };
        lastDoor = { ...doorData };
        delete lastDoor.doorNumber;
        delete lastDoor.doorName;
        doors.push(doorData);
        refreshTable();
        saveData();
        document.getElementById('doorNumber').value = '';
        document.getElementById('doorName').value = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function refreshTable() {
        const tbody = document.getElementById('doorTableBody');
        tbody.innerHTML = '';
        doors.forEach((door, index) => {
            const row = tbody.insertRow();
            const vals = [
                door.doorNumber, door.doorName, door.width, door.height, door.frameDepth, door.dimDetail, door.doorThickness,
                door.frameProfile1, door.frameProfile2, door.doorLeafFinish, door.doorFrameFinish,
                door.architraveProfile, door.cylinderProfile, door.suiteRef, door.overrideType, door.handing
            ];
            vals.forEach(v => { row.insertCell().innerText = (v !== undefined && v !== null && v !== '') ? v : '-'; });
            const actionCell = row.insertCell();
            const delBtn = document.createElement('button');
            delBtn.innerText = 'üóëÔ∏è';
            delBtn.className = 'danger';
            delBtn.style.padding = '4px 8px';
            delBtn.onclick = () => { if (confirm('Delete this door?')) { doors.splice(index, 1); refreshTable(); saveData(); } };
            actionCell.appendChild(delBtn);
        });
        const countEl = document.getElementById('doorCount');
        countEl.innerText = doors.length === 1 ? '1 Door Added' : `${doors.length} Doors Added`;
    }

    function clearAllDoors() { if (confirm('Clear all?')) { doors = []; refreshTable(); saveData(); } }

    function copyPrevious() {
        if (!lastDoor) { alert('No data to copy'); return; }
        Object.keys(lastDoor).forEach(k => { const el = document.getElementById(k); if (el) el.value = lastDoor[k]; });
    }

    function exportCSV() {
        if (!doors || doors.length === 0) { alert('No doors to export'); return; }
        const header = ["Door Number","Door Name","Width","Height","Frame Depth","Dim Detail","Thickness","Frame1","Frame2","Leaf","Frame Finish","Architrave","Cylinder","Suite","Override","Handing"];
        let csv = header.join(',') + "\n";
        doors.forEach(d => {
            const row = [
                d.doorNumber, d.doorName, d.width, d.height, d.frameDepth, d.dimDetail, d.doorThickness,
                d.frameProfile1, d.frameProfile2, d.doorLeafFinish, d.doorFrameFinish,
                d.architraveProfile, d.cylinderProfile, d.suiteRef, d.overrideType, d.handing
            ];
            csv += row.map(v => `"${String(v || '').replace(/"/g,'""')}"`).join(',') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `survey-${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }

    async function exportPDF() {
        try {
            if (!doors || doors.length === 0) { alert('No doors to export'); return; }
            if (typeof window.html2pdf === 'undefined') {
                alert("The PDF export library is still loading or unavailable. Try again in a moment or use the CSV export.");
                return;
            }

            // Create printable container that is off-screen but renderable (do NOT use visibility:hidden)
            const container = document.createElement('div');
            container.style.padding = '12px';
            container.style.background = 'white';
            container.style.color = '#000';
            container.style.fontFamily = 'Arial, Helvetica, sans-serif';
            container.style.width = '800px'; // explicit width helps rendering
            container.style.boxSizing = 'border-box';

            // Important: Move element off-screen and make it invisible but renderable
            container.style.position = 'absolute';
            container.style.left = '-10000px';
            container.style.top = '0';
            container.style.opacity = '0';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '9999';

            const projName = document.getElementById('projectName').value || 'N/A';
            const projRef = document.getElementById('projectRef').value || '';
            const surveyDate = document.getElementById('surveyDate').value || '';
            const surveyor = document.getElementById('surveyorName').value || 'N/A';

            const headerHtml = `
                <div style="text-align:center">
                    <h1 style="margin:0 0 8px 0">Door Survey Report</h1>
                    <p style="margin:0 0 12px 0"><strong>Project:</strong> ${escapeHtml(projName)} ${projRef ? '‚Äî ' + escapeHtml(projRef) : ''}</p>
                    <p style="margin:0 0 12px 0"><strong>Surveyor:</strong> ${escapeHtml(surveyor)} ${surveyDate ? ' | ' + escapeHtml(surveyDate) : ''}</p>
                </div>
            `;
            container.innerHTML = headerHtml;

            // Build table HTML
            let tableHtml = '<table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:8px">';
            tableHtml += '<thead><tr>';
            const cols = ["Door No.","Door Name","Width","Height","Frame Depth","Dim Detail","Thickness","Frame1","Frame2","Leaf Finish","Frame Finish","Architrave","Cylinder","Suite Ref","Override","Handing"];
            cols.forEach(c => {
                tableHtml += `<th style="border:1px solid #333;padding:6px;background:#eee;text-align:left">${escapeHtml(c)}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            doors.forEach(d => {
                tableHtml += '<tr>';
                const vals = [
                    d.doorNumber, d.doorName, d.width, d.height, d.frameDepth, d.dimDetail, d.doorThickness,
                    d.frameProfile1, d.frameProfile2, d.doorLeafFinish, d.doorFrameFinish,
                    d.architraveProfile, d.cylinderProfile, d.suiteRef, d.overrideType, d.handing
                ];
                vals.forEach(v => {
                    tableHtml += `<td style="border:1px solid #333;padding:6px;vertical-align:top">${escapeHtml(v || '-')}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';

            container.innerHTML += tableHtml;

            document.body.appendChild(container);

            // allow a short time for layout/render before capture
            // increased delay to improve reliability on slower devices
            await new Promise(res => setTimeout(res, 300));

            const opt = {
                margin:       0.4,
                filename:     `Door-Survey-${Date.now()}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(container).save();

            // cleanup
            if (container && container.parentNode) document.body.removeChild(container);
        } catch (err) {
            console.error('PDF export failed', err);
            alert('Failed to export PDF. See console for details.');
        }
    }

    function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, function (m) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
        });
    }

    loadData();

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installPrompt').style.display = 'block'; });
    function installApp() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; document.getElementById('installPrompt').style.display = 'none'; } }
</script>

</body>
</html>
