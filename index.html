<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Door Survey App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; padding-bottom: 20px; -webkit-font-smoothing: antialiased; }
        h1 { background: #007bff; color: white; margin: 0; padding: 16px; font-size: 22px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 16px 0; font-size: 18px; color: #333; }
        .section { background: #fff; padding: 16px; margin: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 600; font-size: 14px; color: #555; }
        input, textarea { width: 100%; padding: 12px; margin: 0; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: #fafafa; transition: all 0.2s; }
        input:focus, textarea:focus { outline: none; border-color: #007bff; background: white; }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        button { width: 100%; padding: 14px; margin-top: 12px; font-size: 16px; font-weight: 600; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; transition: transform 0.08s, box-shadow 0.08s; }
        button:active { transform: scale(0.98); box-shadow: 0 1px 4px rgba(0,123,255,0.3); }
        button.secondary { background: #6c757d; box-shadow: 0 2px 8px rgba(108,117,125,0.3); }
        button.copy { background: #28a745; box-shadow: 0 2px 8px rgba(40,167,69,0.3); }
        button.danger { background: #dc3545; box-shadow: 0 2px 8px rgba(220,53,69,0.3); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { border: 1px solid #ddd; padding: 8px 6px; font-size: 13px; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; font-weight: 600; position: sticky; top: 0; }
        tr:nth-child(even) { background: #f9f9f9; }
        .door-count { background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block; margin-bottom: 12px; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .install-prompt { background: #fff3cd; border: 2px solid #ffc107; padding: 12px; margin: 12px; border-radius: 8px; display: none; }
        /* Image modal */
        #imageModal { position: fixed; left: 0; right: 0; top: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 12px; }
        #imageModal .modal-content { background: white; border-radius: 10px; max-width: 760px; width: 100%; max-height: 90vh; overflow: auto; padding: 12px; }
        #imageModal img { max-width: 100%; border-radius: 8px; margin-bottom: 8px; display: block; }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .image-card { background: #f8f9fa; border-radius: 8px; padding: 8px; text-align: center; }
        .small-btn { padding: 6px 8px; font-size: 13px; border-radius: 8px; width: auto; display:inline-block; margin-top: 6px; }
        @media (max-width: 520px) {
            table { min-width: 720px; }
        }
    </style>
</head>
<body>

<h1>üö™ Door Survey</h1>

<div id="installPrompt" class="install-prompt">
    <strong>üì± Install this app!</strong>
    <p style="margin: 8px 0; font-size: 14px;">Add to your home screen for easy access and offline use.</p>
    <button onclick="installApp()">Install App</button>
    <button onclick="document.getElementById('installPrompt').style.display='none'" style="background: #6c757d; margin-top: 4px;">Maybe Later</button>
</div>

<div class="section">
    <h2>Project Information</h2>
    <label>Project Ref</label><input id="projectRef">
    <label>Project Name</label><input id="projectName">
    <label>Survey Date</label><input id="surveyDate" type="date">
    <label>Surveyor Name</label><input id="surveyorName">
</div>

<div class="section">
    <h2>Add Door</h2>
    <button class="copy" onclick="copyPrevious()">üîÅ Copy Previous Door Details</button>

    <label>Door Number</label><input id="doorNumber" type="text" placeholder="e.g., D01">
    <label>Door Name</label><input id="doorName" type="text" placeholder="e.g., Main Entrance">
    <label>Width (mm)</label><input id="width" type="number">
    <label>Height (mm)</label><input id="height" type="number">
    <label>Frame Depth</label><input id="frameDepth" type="text">
    <label>Dimension Detail</label><textarea id="dimDetail"></textarea>
    <label>Existing Door Thickness</label><input id="doorThickness" type="text">
    <label>Existing Frame Profile 1</label><input id="frameProfile1" type="text">
    <label>Existing Frame Profile 2</label><input id="frameProfile2" type="text">
    <label>Door Leaf Finish</label><input id="doorLeafFinish" type="text">
    <label>Door Frame Finish</label><input id="doorFrameFinish" type="text">
    <label>Existing Architrave Profile</label><input id="architraveProfile" type="text">
    <label>Existing Cylinder Profile</label><input id="cylinderProfile" type="text">
    <label>Existing Suite Ref</label><input id="suiteRef" type="text">
    <label>Existing Override Type</label><input id="overrideType" type="text">
    <label>Handing</label><input id="handing" type="text" placeholder="e.g., LH or RH">

    <label>Attach Images</label>
    <input id="imagesInput" type="file" accept="image/*" multiple>
    <small style="color:#666; display:block; margin-top:6px;">Select one or more photos for this door. They are saved locally and included in exports.</small>

    <button onclick="addDoor()">‚ûï Add Door to Schedule</button>
</div>

<div class="section">
    <h2>Door Schedule</h2>
    <div class="door-count" id="doorCount">0 Doors Added</div>
    <div class="table-container">
        <table id="doorTable">
            <thead>
                <tr>
                    <th>Door No.</th><th>Door Name</th><th>Width</th><th>Height</th><th>Frame Depth</th>
                    <th>Dim Detail</th><th>Thickness</th><th>Frame 1</th><th>Frame 2</th>
                    <th>Leaf Finish</th><th>Frame Finish</th><th>Architrave</th><th>Cylinder</th>
                    <th>Suite Ref</th><th>Override</th><th>Handing</th><th>Images</th><th>Action</th>
                </tr>
            </thead>
            <tbody id="doorTableBody"></tbody>
        </table>
    </div>

    <div class="button-group">
        <button class="secondary" onclick="exportCSV()">üì§ Export CSV</button>
        <button class="secondary" onclick="exportImages()">üñºÔ∏è Export Images (ZIP)</button>
    </div>
    <button class="copy" onclick="exportAll()">üì¶ Export CSV + Images (ZIP)</button>
    <button class="danger" onclick="clearAllDoors()">üóëÔ∏è Clear All Doors</button>
</div>

<!-- Image preview modal -->
<div id="imageModal" onclick="hideImageModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <strong id="modalTitle">Images</strong>
            <button onclick="closeImageModal()" style="background:#dc3545; color:white; padding:8px 10px; border-radius:8px;">Close</button>
        </div>
        <div id="modalBody" class="image-grid"></div>
    </div>
</div>

<!-- JSZip library for zipping files -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
    document.getElementById("surveyDate").value = new Date().toISOString().split("T")[0];
    let doors = [];
    let lastDoor = null;
    let deferredPrompt;

    function loadData() {
        try {
            const saved = localStorage.getItem('doorSurveyData');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('projectRef').value = data.projectRef || '';
                document.getElementById('projectName').value = data.projectName || '';
                document.getElementById('surveyDate').value = data.surveyDate || '';
                document.getElementById('surveyorName').value = data.surveyorName || '';
                doors = data.doors || [];
                // set lastDoor from last entry (excluding number & name)
                if (doors.length) {
                    const ld = Object.assign({}, doors[doors.length - 1]);
                    delete ld.doorNumber; delete ld.doorName;
                    lastDoor = ld;
                }
                refreshTable();
            }
        } catch (e) { console.error('Error loading data', e); }
    }

    function saveData() {
        const data = {
            projectRef: document.getElementById('projectRef').value,
            projectName: document.getElementById('projectName').value,
            surveyDate: document.getElementById('surveyDate').value,
            surveyorName: document.getElementById('surveyorName').value,
            doors: doors
        };
        try {
            localStorage.setItem('doorSurveyData', JSON.stringify(data));
        } catch (e) {
            console.warn('Could not save data to localStorage', e);
        }
    }

    ['projectRef', 'projectName', 'surveyDate', 'surveyorName'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', saveData);
    });

    async function readFilesAsDataURLs(fileList) {
        const files = Array.from(fileList || []);
        return Promise.all(files.map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ name: file.name, dataUrl: reader.result });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }));
    }

    async function addDoor() {
        const dNo = document.getElementById('doorNumber').value.trim();
        if (!dNo) { alert('Please enter a Door Number'); return; }
        const imagesFiles = document.getElementById('imagesInput').files;
        let images = [];
        try {
            images = await readFilesAsDataURLs(imagesFiles);
        } catch (e) {
            console.error('Error reading images', e);
            alert('Error reading selected images.');
        }

        const doorData = {
            doorNumber: dNo,
            doorName: document.getElementById('doorName').value,
            width: document.getElementById('width').value,
            height: document.getElementById('height').value,
            frameDepth: document.getElementById('frameDepth').value,
            dimDetail: document.getElementById('dimDetail').value,
            doorThickness: document.getElementById('doorThickness').value,
            frameProfile1: document.getElementById('frameProfile1').value,
            frameProfile2: document.getElementById('frameProfile2').value,
            doorLeafFinish: document.getElementById('doorLeafFinish').value,
            doorFrameFinish: document.getElementById('doorFrameFinish').value,
            architraveProfile: document.getElementById('architraveProfile').value,
            cylinderProfile: document.getElementById('cylinderProfile').value,
            suiteRef: document.getElementById('suiteRef').value,
            overrideType: document.getElementById('overrideType').value,
            handing: document.getElementById('handing').value,
            images: images // array of {name, dataUrl}
        };
        lastDoor = { ...doorData };
        delete lastDoor.doorNumber;
        delete lastDoor.doorName;
        doors.push(doorData);
        refreshTable();
        saveData();
        document.getElementById('doorNumber').value = '';
        document.getElementById('doorName').value = '';
        // clear file input
        document.getElementById('imagesInput').value = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function refreshTable() {
        const tbody = document.getElementById('doorTableBody');
        tbody.innerHTML = '';
        doors.forEach((door, index) => {
            const row = tbody.insertRow();
            const vals = [
                door.doorNumber, door.doorName, door.width, door.height, door.frameDepth, door.dimDetail, door.doorThickness,
                door.frameProfile1, door.frameProfile2, door.doorLeafFinish, door.doorFrameFinish,
                door.architraveProfile, door.cylinderProfile, door.suiteRef, door.overrideType, door.handing
            ];
            vals.forEach(v => { row.insertCell().innerText = (v !== undefined && v !== null && v !== '') ? v : '-'; });

            // Images cell
            const imgCell = row.insertCell();
            const imgCount = (door.images && door.images.length) ? door.images.length : 0;
            const imgLabel = document.createElement('span');
            imgLabel.innerText = imgCount ? `${imgCount} image${imgCount>1?'s':''}` : '-';
            imgLabel.style.display = 'inline-block';
            imgLabel.style.marginRight = '8px';
            imgCell.appendChild(imgLabel);
            if (imgCount) {
                const viewBtn = document.createElement('button');
                viewBtn.innerText = 'View';
                viewBtn.className = 'small-btn';
                viewBtn.style.background = '#007bff';
                viewBtn.style.color = 'white';
                viewBtn.onclick = () => showImagesModal(index);
                imgCell.appendChild(viewBtn);
            }

            const actionCell = row.insertCell();
            const delBtn = document.createElement('button');
            delBtn.innerText = 'üóëÔ∏è';
            delBtn.className = 'danger';
            delBtn.style.padding = '6px 10px';
            delBtn.onclick = () => { if (confirm('Delete this door?')) { doors.splice(index, 1); refreshTable(); saveData(); } };
            actionCell.appendChild(delBtn);
        });
        const countEl = document.getElementById('doorCount');
        countEl.innerText = doors.length === 1 ? '1 Door Added' : `${doors.length} Doors Added`;
    }

    function clearAllDoors() { if (confirm('Clear all?')) { doors = []; refreshTable(); saveData(); } }

    function copyPrevious() {
        if (!lastDoor) { alert('No data to copy'); return; }
        Object.keys(lastDoor).forEach(k => { const el = document.getElementById(k); if (el) el.value = lastDoor[k]; });
    }

    function csvEscape(val) {
        return `"${String(val || '').replace(/"/g, '""')}"`;
    }

    // CSV export: project block (labels + values) on top, then door table with full headings
    function exportCSV() {
        if (!doors || doors.length === 0) { alert('No doors to export'); return; }

        // Project info header and values (separate block)
        const projectHeader = ["Project Ref", "Project Name", "Survey Date", "Surveyor Name"];
        const projectValues = [
            document.getElementById('projectRef').value || '',
            document.getElementById('projectName').value || '',
            document.getElementById('surveyDate').value || '',
            document.getElementById('surveyorName').value || ''
        ];

        // Door table header (full set of headings)
        const doorHeader = ["Door Number","Door Name","Width","Height","Frame Depth","Dim Detail","Thickness","Frame1","Frame2","Leaf","Frame Finish","Architrave","Cylinder","Suite","Override","Handing","ImagesCount"];

        let csv = '';
        // Add project info block (labels row + values row), separated from door table by a blank line
        csv += projectHeader.map(csvEscape).join(',') + '\n';
        csv += projectValues.map(csvEscape).join(',') + '\n\n';

        // Add door header and rows
        csv += doorHeader.map(csvEscape).join(',') + "\n";
        doors.forEach(d => {
            const row = [
                d.doorNumber, d.doorName, d.width, d.height, d.frameDepth, d.dimDetail, d.doorThickness,
                d.frameProfile1, d.frameProfile2, d.doorLeafFinish, d.doorFrameFinish,
                d.architraveProfile, d.cylinderProfile, d.suiteRef, d.overrideType, d.handing,
                (d.images && d.images.length) ? d.images.length : 0
            ];
            csv += row.map(v => csvEscape(v)).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `survey-${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }

    // Helper to convert dataURL to ArrayBuffer via fetch (works in browsers)
    async function dataUrlToArrayBuffer(dataUrl) {
        const res = await fetch(dataUrl);
        return await res.arrayBuffer();
    }

    // Export only images as a ZIP (images grouped in folders per door number)
    async function exportImages() {
        if (!doors || doors.length === 0) { alert('No doors / images to export'); return; }
        const zip = new JSZip();
        let anyImage = false;

        for (let i = 0; i < doors.length; i++) {
            const door = doors[i];
            if (!door.images || door.images.length === 0) continue;
            anyImage = true;
            const folderName = sanitizeFilename(`${door.doorNumber || 'door-' + (i+1)}`);
            const folder = zip.folder(folderName);
            for (let j = 0; j < door.images.length; j++) {
                const img = door.images[j];
                try {
                    const ab = await dataUrlToArrayBuffer(img.dataUrl);
                    // try to keep original filename if present, otherwise create a name
                    const filename = sanitizeFilename(img.name || `image-${j+1}.jpg`);
                    folder.file(filename, ab);
                } catch (e) {
                    console.warn('Skipping image due to error', e);
                }
            }
        }

        if (!anyImage) { alert('No images attached to any doors.'); return; }

        zip.generateAsync({ type: 'blob' }).then(function(content) {
            const a = document.createElement('a');
            const url = URL.createObjectURL(content);
            a.href = url;
            a.download = `door-images-${Date.now()}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    // Export both CSV and Images together in one ZIP
    async function exportAll() {
        if (!doors || doors.length === 0) { alert('No doors to export'); return; }
        const zip = new JSZip();

        // Project info header and values (separate block in CSV)
        const projectHeader = ["Project Ref", "Project Name", "Survey Date", "Surveyor Name"];
        const projectValues = [
            document.getElementById('projectRef').value || '',
            document.getElementById('projectName').value || '',
            document.getElementById('surveyDate').value || '',
            document.getElementById('surveyorName').value || ''
        ];

        // Door table header (full set of headings)
        const doorHeader = ["Door Number","Door Name","Width","Height","Frame Depth","Dim Detail","Thickness","Frame1","Frame2","Leaf","Frame Finish","Architrave","Cylinder","Suite","Override","Handing","ImagesCount"];

        let csv = '';
        csv += projectHeader.map(csvEscape).join(',') + '\n';
        csv += projectValues.map(csvEscape).join(',') + '\n\n';
        csv += doorHeader.map(csvEscape).join(',') + "\n";
        doors.forEach(d => {
            const row = [
                d.doorNumber, d.doorName, d.width, d.height, d.frameDepth, d.dimDetail, d.doorThickness,
                d.frameProfile1, d.frameProfile2, d.doorLeafFinish, d.doorFrameFinish,
                d.architraveProfile, d.cylinderProfile, d.suiteRef, d.overrideType, d.handing,
                (d.images && d.images.length) ? d.images.length : 0
            ];
            csv += row.map(v => csvEscape(v)).join(',') + '\n';
        });

        zip.file('survey.csv', csv);

        // Add images in a folder "images/<doorNumber>/"
        let anyImage = false;
        for (let i = 0; i < doors.length; i++) {
            const door = doors[i];
            if (!door.images || door.images.length === 0) continue;
            anyImage = true;
            const folderName = sanitizeFilename(`images/${door.doorNumber || 'door-' + (i+1)}`);
            const folder = zip.folder(folderName);
            for (let j = 0; j < door.images.length; j++) {
                const img = door.images[j];
                try {
                    const ab = await dataUrlToArrayBuffer(img.dataUrl);
                    const filename = sanitizeFilename(img.name || `image-${j+1}.jpg`);
                    folder.file(filename, ab);
                } catch (e) {
                    console.warn('Skipping image due to error', e);
                }
            }
        }

        zip.generateAsync({ type: 'blob' }).then(function(content) {
            const a = document.createElement('a');
            const url = URL.createObjectURL(content);
            a.href = url;
            a.download = `survey-and-images-${Date.now()}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    function sanitizeFilename(name) {
        return name.replace(/[<>:"/\\|?*\u0000-\u001F]/g, '_').replace(/\s+/g, '_');
    }

    // Image modal functions
    function showImagesModal(doorIndex) {
        const door = doors[doorIndex];
        const modal = document.getElementById('imageModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        modalTitle.innerText = `Images for ${door.doorNumber || 'Door ' + (doorIndex+1)}`;
        modalBody.innerHTML = '';
        if (!door.images || door.images.length === 0) {
            modalBody.innerHTML = '<p>No images attached.</p>';
        } else {
            door.images.forEach((img, idx) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                const imageEl = document.createElement('img');
                imageEl.src = img.dataUrl;
                imageEl.alt = img.name || `Image ${idx+1}`;
                imageEl.style.maxHeight = '140px';
                card.appendChild(imageEl);
                const nameEl = document.createElement('div');
                nameEl.style.fontSize = '12px';
                nameEl.style.color = '#333';
                nameEl.style.marginTop = '6px';
                nameEl.innerText = img.name || `image-${idx+1}`;
                card.appendChild(nameEl);

                const dlBtn = document.createElement('button');
                dlBtn.innerText = 'Download';
                dlBtn.className = 'small-btn';
                dlBtn.style.background = '#28a745';
                dlBtn.style.color = 'white';
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = img.dataUrl;
                    a.download = sanitizeFilename(img.name || `image-${idx+1}.jpg`);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
                card.appendChild(dlBtn);

                modalBody.appendChild(card);
            });
        }
        modal.style.display = 'flex';
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
    }

    function hideImageModal(event) {
        if (event.target.id === 'imageModal') closeImageModal();
    }

    loadData();

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installPrompt').style.display = 'block'; });
    function installApp() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; document.getElementById('installPrompt').style.display = 'none'; } }
</script>

</body>
</html>
